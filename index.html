<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayCash App - Ø¢Ù† Ù„Ø§Ø¦Ù† Ú©Ù…Ø§Ø¦ÛŒÚº</title>
    <!-- Google Fonts: Almarai for Urdu -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tailwind CSS (For Basic Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS to ensure Urdu Font and direction is correct */
        body {
            font-family: 'Almarai', sans-serif;
            text-align: right;
            direction: rtl; /* Right-to-Left for Urdu */
            background-color: #f7f9fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 420px;
            width: 100%;
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border-right: 4px solid #3b82f6; /* Blue accent bar on the right */
        }

        h2, h3 {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-weight: 700;
            color: #1f2937;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.3s;
            font-weight: 700;
        }
        
        .btn-primary.disabled, .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
            text-align: right;
        }

        /* Message Box Styling */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1f2937;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none; /* Initially hidden */
            text-align: center;
            width: 90%;
            max-width: 350px;
        }

        #message-box h3 {
            color: #fcd34d; /* Yellow color */
            border-bottom: none;
            margin-bottom: 10px;
        }
        
        #message-box p {
            font-size: 1rem;
            line-height: 1.6;
        }

        #timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ef4444; /* Red color for timer */
            direction: ltr; /* Timer should be LTR */
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
    <!-- Firebase SDKs (Latest compatible version for v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body dir="rtl">
    <div class="container">
        
        <!-- 1. Loading/Error Section -->
        <div id="loading-message" class="card" style="text-align: center;">
            <div class="loading-spinner"></div>
            <h3 class="text-xl">Ú©Ù†ÛŒÚ©Ù¹ ÛÙˆ Ø±ÛØ§ ÛÛ’...</h3>
        </div>

        <div id="error-message" class="card" style="display: none; text-align: center;">
            <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
            <h3 class="text-xl text-red-600">Ú©ÙˆØ¦ÛŒ Ù…Ø³Ø¦Ù„Û ÛÛ’!</h3>
            <p id="error-text">Ú©Ù†Ú©Ø´Ù† ÛŒØ§ ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ Ú©Ø§ Ù…Ø³Ø¦Ù„Û ÛÛ’Û”</p>
        </div>

        <!-- 2. Login/Registration Section -->
        <div id="login-container" class="card login-container" style="display: none;">
            <h2 class="text-2xl">Ù„Ø§Ú¯ Ø§Ù† / Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù†</h2>
            <form id="login-form">
                <input type="text" id="username-input" class="input-field" placeholder="ÛŒÙˆØ²Ø± Ù†ÛŒÙ… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº (e.g. ali123)" required>
                <button type="submit" class="btn-primary w-full mt-3">
                    <i class="fas fa-sign-in-alt"></i> Ù„Ø§Ú¯ Ø§Ù† / Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù†
                </button>
            </form>
        </div>

        <!-- 3. Main User Dashboard Section -->
        <div id="dashboard-section" style="display: none;">
            
            <div class="card bg-blue-500 text-white" style="border-right: 4px solid #fcd34d;">
                <h3 class="text-xl border-b border-white border-opacity-30 pb-2">ÛŒÙˆØ²Ø± ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ</h3>
                <p>ÛŒÙˆØ²Ø± Ø¢Ø¦ÛŒ ÚˆÛŒ: <span id="user-id-display" class="font-mono text-sm block mt-1">...</span></p>
                <p class="text-3xl mt-4">Ø¢Ù¾ Ú©Û’ Ù¾ÙˆØ§Ø¦Ù†Ù¹Ø³: <span id="points-display" class="font-bold">0</span></p>
            </div>

            <!-- 4. Daily Claim Section -->
            <div id="claim-section" class="card">
                <h3 class="text-xl"><i class="fas fa-coins"></i> Ø±ÙˆØ²Ø§Ù†Û Ú©Ù„ÛŒÙ…</h3>
                <p id="claim-message" class="text-gray-600 mb-3">ÛØ± 24 Ú¯Ú¾Ù†Ù¹Û’ Ø¨Ø¹Ø¯ Ù¾ÙˆØ§Ø¦Ù†Ù¹Ø³ Ú©Ù„ÛŒÙ… Ú©Ø±ÛŒÚº!</p>
                <div id="timer-display-container" style="display: none; text-align: center;">
                    <p class="text-sm text-gray-500 mb-2">Ø§Ú¯Ù„Ø§ Ú©Ù„ÛŒÙ…:</p>
                    <p id="timer-display" class="mb-4">00:00:00</p>
                </div>
                <button id="claim-button" class="btn-primary w-full" disabled>
                    <i class="fas fa-clock"></i> Ù¾ÙˆØ§Ø¦Ù†Ù¹Ø³ Ú©Ù„ÛŒÙ… Ú©Ø±ÛŒÚº
                </button>
            </div>
            
            <!-- 5. Rewards Section -->
            <div id="reward-section" class="card">
                <h3 class="text-xl"><i class="fas fa-gift"></i> Ø§Ù†Ø¹Ø§Ù…Ø§Øª Ø§ÙˆØ± Ø±ÛŒÙˆØ§Ø±ÚˆØ²</h3>
                <p id="reward-message" class="text-gray-600 mb-3">ÛŒÛØ§Úº Ø¢Ù¾ Ú©Û’ Ù„ÛŒÙˆÙ„ Ú©Û’ Ù…Ø·Ø§Ø¨Ù‚ Ø§Ù†Ø¹Ø§Ù…Ø§Øª Ø¯Ú©Ú¾Ø§Ø¦Û’ Ø¬Ø§Ø¦ÛŒÚº Ú¯Û’Û”</p>
                <button class="btn-primary w-full mt-3 opacity-50" disabled>
                    <i class="fas fa-money-check-alt"></i> Ø±Ù‚Ù… Ù†Ú©Ø§Ù„ÛŒÚº (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)
                </button>
            </div>
            
            <!-- 6. Logout Button -->
            <button id="logout-button" class="btn-primary w-full bg-red-500 hover:bg-red-600 mt-4">
                <i class="fas fa-sign-out-alt"></i> Ù„Ø§Ú¯ Ø¢Ø¤Ù¹
            </button>
        </div>
    </div>
    
    <!-- Custom Modal/Message Box -->
    <div id="message-box">
        <h3 id="message-title">Ù¾ÛŒØºØ§Ù…</h3>
        <p id="message-content" class="text-lg my-3"></p>
        <button id="message-close-button" class="btn-primary bg-yellow-500 hover:bg-yellow-600 px-6 mt-3">Ù¹Ú¾ÛŒÚ© ÛÛ’</button>
    </div>

    <!-- External JavaScript (Scripting Logic) -->
    <script>
        // --- Firebase Configuration (IMPORTANT: REPLACE WITH YOURS!) ---
        // Ø§Ø³ Ø¬Ú¯Û Ø§Ù¾Ù†ÛŒ Ø§ØµÙ„ Firebase Ú©ÛŒØ² ÚˆØ§Ù„ÛŒÚºÛ” Ø§Ú¯Ø± Ù†ÛÛŒÚº ÚˆØ§Ù„ÛŒÚº Ú¯Û’ ØªÙˆ Ø§ÛŒÙ¾ Ú©Ø§Ù… Ù†ÛÛŒÚº Ú©Ø±Û’ Ú¯ÛŒÛ”
        const firebaseConfig = {
            apiKey: "AIzaSyC_Your_API_Key_Goes_Here", // <-- ÛŒÛØ§Úº Ø¨Ø¯Ù„ÛŒÚº
            authDomain: "paycash-92256.firebaseapp.com", // <-- ÛŒÛØ§Úº Ø¨Ø¯Ù„ÛŒÚº
            databaseURL: "https://paycash-92256-default-rtdb.firebaseio.com", // <-- ÛŒÛØ§Úº Ø¨Ø¯Ù„ÛŒÚº
            projectId: "paycash-92256", // <-- ÛŒÛØ§Úº Ø¨Ø¯Ù„ÛŒÚº
            storageBucket: "paycash-92256.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };
        
        // Initialize Firebase
        let app;
        let auth;
        let db;

        // Initialize App function
        function initializeApp() {
            try {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app(); 
                }
                
                auth = firebase.auth();
                db = firebase.database();
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayError("ÙØ§Ø¦Ø± Ø¨ÛŒØ³ Ø³ÛŒÙ¹Ù†Ú¯Ø² Ù…ÛŒÚº Ú©ÙˆØ¦ÛŒ ØºÙ„Ø·ÛŒ ÛÛ’! Ø¨Ø±Ø§Û Ú©Ø±Ù… console Ú†ÛŒÚ© Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ø§Ù¾Ù†ÛŒ API Ú©ÛŒØ² Ø¯Ø±Ø³Øª Ú©Ø±ÛŒÚºÛ”");
                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
            }
        }

        // --- UI Element References ---
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const loginContainer = document.getElementById('login-container');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const pointsDisplay = document.getElementById('points-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const claimButton = document.getElementById('claim-button');
        const logoutButton = document.getElementById('logout-button');
        const timerDisplayContainer = document.getElementById('timer-display-container');
        const timerDisplay = document.getElementById('timer-display');
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const messageCloseButton = document.getElementById('message-close-button');

        // --- Global Variables ---
        let currentUserId = null;
        const CLAIM_INTERVAL_HOURS = 24;
        let claimTimerInterval = null;


        // --- Message/Alert Function ---
        function showMessage(title, content) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageBox.style.display = 'block';
        }

        messageCloseButton.onclick = () => {
            messageBox.style.display = 'none';
        };

        // --- Error Handler ---
        function displayError(text) {
            document.getElementById('error-text').textContent = text;
            errorMessage.style.display = 'block';
            loadingMessage.style.display = 'none';
            loginContainer.style.display = 'none';
            dashboardSection.style.display = 'none';
        }


        // --- AUTHENTICATION HANDLERS ---

        // 1. User Sign-in/Registration Handler
        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (username.length < 3) {
                showMessage("ØºÙ„Ø·ÛŒ", "ÛŒÙˆØ²Ø± Ù†ÛŒÙ… Ú©Ù… Ø§Ø² Ú©Ù… 3 Ø­Ø±ÙˆÙ Ù¾Ø± Ù…Ø´ØªÙ…Ù„ ÛÙˆÙ†Ø§ Ú†Ø§ÛÛŒÛ’!");
                return;
            }

            // Firebase Anonymous Authentication
            try {
                // We are using anonymous auth, so we link the username to the UID
                const result = await auth.signInAnonymously();
                currentUserId = result.user.uid;
                
                const userRef = db.ref('users/'_ + currentUserId);
                const snapshot = await userRef.once('value');

                if (!snapshot.exists()) {
                    // New user: Save username and initial points
                    await userRef.set({
                        username: username,
                        points: 0,
                        lastClaimTimestamp: 0 // 0 means never claimed
                    });
                    showMessage("Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!", ${username}ØŒ Ø¢Ù¾ Ú©Ø§ Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù† Ú¯ÛŒØ§ ÛÛ’Û”);
                } 
                // Existing user: The onAuthStateChanged listener will handle the rest
            } catch (error) {
                console.error("Sign-in/Registration error:", error);
                showMessage("ØºÙ„Ø·ÛŒ", "Ù„Ø§Ú¯ Ø§Ù† Ú©Ø±ØªÛ’ ÙˆÙ‚Øª Ú©ÙˆØ¦ÛŒ Ù…Ø³Ø¦Ù„Û ÛÙˆØ§: " + error.message);
            }
        };

        // 2. Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            loadingMessage.style.display = 'none';

            if (user) {
                // User is logged in
                currentUserId = user.uid;
                loginContainer.style.display = 'none';
                dashboardSection.style.display = 'block';
                
                // Start listening to user data changes
                listenToUserData(currentUserId);

            } else {
                // User is logged out
                currentUserId = null;
                loginContainer.style.display = 'block';
                dashboardSection.style.display = 'none';
                if (claimTimerInterval) {
                    clearInterval(claimTimerInterval);
                }
            }
        });

        logoutButton.onclick = async () => {
            try {
                await auth.signOut();
                showMessage("Ù„Ø§Ú¯ Ø¢Ø¤Ù¹", "Ø¢Ù¾ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ù„Ø§Ú¯ Ø¢Ø¤Ù¹ ÛÙˆ Ú¯Ø¦Û’ ÛÛŒÚºÛ”");
            } catch (error) {
                console.error("Logout error:", error);
                showMessage("ØºÙ„Ø·ÛŒ", "Ù„Ø§Ú¯ Ø¢Ø¤Ù¹ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒÛ”");
            }
        };


        // --- DATABASE LISTENERS ---

        // Listen for real-time changes to user data
        function listenToUserData(userId) {
            const userRef = db.ref('users/'_ + userId);
            
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                
                if (userData) {
                    userIdDisplay.textContent = userId;
                    pointsDisplay.textContent = userData.points || 0;
                    document.title = PayCash App - ${userData.username};
                    
                    updateClaimStatus(userData.lastClaimTimestamp || 0);

                } else {
                    console.warn("User data not found for UID:", userId);
                    // This might mean the user is new and hasn't set a username yet
                    // Or data was deleted.
                    loginContainer.style.display = 'block'; // Show login to re-create
                    dashboardSection.style.display = 'none';
                }
            }, (error) => {
                console.error("Database Read Error:", error);
                displayError("ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒ: Ø³ÛŒÚ©ÛŒÙˆØ±Ù¹ÛŒ Ø±ÙˆÙ„Ø² Ú†ÛŒÚ© Ú©Ø±ÛŒÚºÛ”");
            });
        }


        // --- CLAIM AND TIMER LOGIC ---

        function updateClaimStatus(lastClaimTimestamp) {
            const now = Date.now();
            const claimIntervalMs = CLAIM_INTERVAL_HOURS * 60 * 60 * 1000;
            const nextClaimTimeMs = lastClaimTimestamp + claimIntervalMs;
            
            if (claimTimerInterval) {
                clearInterval(claimTimerInterval);
            }

            if (now >= nextClaimTimeMs) {
                // Claim is ready
                claimButton.disabled = false;
                claimButton.textContent = 'Ù¾ÙˆØ§Ø¦Ù†Ù¹Ø³ Ú©Ù„ÛŒÙ… Ú©Ø±ÛŒÚº';
                timerDisplayContainer.style.display = 'none';
                document.getElementById('claim-message').textContent = 'ğŸ¥³ Ø²Ø¨Ø±Ø¯Ø³Øª! Ø¢Ù¾ Ø§Ø¨Ú¾ÛŒ Ø§Ù¾Ù†Û’ Ù¾ÙˆØ§Ø¦Ù†Ù¹Ø³ Ú©Ù„ÛŒÙ… Ú©Ø± Ø³Ú©ØªÛ’ ÛÛŒÚº!';
            } else {
                // Claim is not ready, start timer
                claimButton.disabled = true;
                timerDisplayContainer.style.display = 'block';
                document.getElementById('claim-message').textContent = 'Ø±ÙˆØ²Ø§Ù†Û Ú©Ù„ÛŒÙ… Ú©Û’ Ù„ÛŒÛ’ Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø±ÛŒÚº:';
                
                startTimer(nextClaimTimeMs);
            }
        }

        function startTimer(targetTimeMs) {
            const updateTimer = () => {
                const now = Date.now();
                const timeLeftMs = targetTimeMs - now;

                if (timeLeftMs <= 0) {
                    clearInterval(claimTimerInterval);
                    updateClaimStatus(0); // Set to 0 to trigger 'ready' state
                    return;
                }

                const totalSeconds = Math.floor(timeLeftMs / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                timerDisplay.textContent = 
                    ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')};
            };

            updateTimer();
            claimTimerInterval = setInterval(updateTimer, 1000);
        }

        // Claim button click handler
        claimButton.onclick = async () => {
            if (!currentUserId) return showMessage("ØºÙ„Ø·ÛŒ", "Ù„Ø§Ú¯ Ø§Ù† Ú©Ø±ÛŒÚº!");

            const userRef = db.ref('users/'_ + currentUserId);
            const now = Date.now();
            
            try {
                // This update will be checked by Firebase Rules
                await userRef.child('lastClaimTimestamp').set(now);
                
                // The rules will let this pass because it's the user updating their own timestamp.
                // NOTE: The points update must be done manually by an Admin.
                
                showMessage("Ú©Ù„ÛŒÙ… ÛÙˆ Ú¯ÛŒØ§!", "Ø¢Ù¾ Ú©Ø§ Ú©Ù„ÛŒÙ… Ù¹Ø§Ø¦Ù… Ø±ÛŒÚ©Ø§Ø±Úˆ ÛÙˆ Ú¯ÛŒØ§ ÛÛ’! Ø§ÛŒÚˆÙ…Ù† Ø¬Ù„Ø¯ ÛÛŒ Ø¢Ù¾ Ú©Û’ Ù¾ÙˆØ§Ø¦Ù†Ù¹Ø³ Ø¨Ú‘Ú¾Ø§ Ø¯Û’ Ú¯Ø§Û”");
                
                updateClaimStatus(now);

            } catch (error) {
                console.error("Claim attempt failed:", error);
                if (error.code === 'PERMISSION_DENIED') {
                    showMessage("Ø³ÛŒÚ©ÛŒÙˆØ±Ù¹ÛŒ Ú©ÛŒ ØºÙ„Ø·ÛŒ", "Ø¢Ù¾ Ú©Ùˆ Ø¯ÙˆØ³Ø±Û’ ÛŒÙˆØ²Ø± Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ø¨Ø¯Ù„Ù†Û’ Ú©ÛŒ Ø§Ø¬Ø§Ø²Øª Ù†ÛÛŒÚº ÛÛ’Û”");
                } else {
                    showMessage("ØºÙ„Ø·ÛŒ", "Ú©Ù„ÛŒÙ… Ú©Ø±ØªÛ’ ÙˆÙ‚Øª Ú©ÙˆØ¦ÛŒ Ù…Ø³Ø¦Ù„Û ÛÙˆØ§: " + error.message);
                }
            }
        };

        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>